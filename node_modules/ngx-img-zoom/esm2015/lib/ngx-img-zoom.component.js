/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, Renderer2, ElementRef, ViewChild, Input, HostListener } from '@angular/core';
import { NgxImgZoomService } from './ngx-img-zoom.service';
export class NgxImgZoomComponent {
    /**
     * @param {?} renderer
     * @param {?} ngxZoomService
     */
    constructor(renderer, ngxZoomService) {
        this.renderer = renderer;
        this.ngxZoomService = ngxZoomService;
        this.hide = true;
        this._triggerAnimationIn = false;
        this.notFirstTime = false;
        this.showResult = false;
        this.zoomMode = this.ngxZoomService.zoomMode;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set imgStyle(val) {
        this._imgStyle = val;
    }
    /**
     * @return {?}
     */
    get imgStyle() {
        return this._imgStyle;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set resultStyle(val) {
        this._resultStyle = val;
    }
    /**
     * @return {?}
     */
    get resultStyle() {
        return this._resultStyle;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set lensStyle(val) {
        this._lensStyle = val;
        if (this.notFirstTime) {
            this.imageZoom();
        }
    }
    /**
     * @return {?}
     */
    get lensStyle() {
        return this._lensStyle;
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onscroll(event) {
        this.hide = true;
        this.renderer.setStyle(this.lens, 'visibility', 'hidden');
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onclick(event) {
        this.hide = true;
        this.renderer.setStyle(this.lens, 'visibility', 'hidden');
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set _imgSrc(val) {
        this.zoomImage = val;
        if (this.notFirstTime === true) {
            this.renderer.setStyle(this.result, 'backgroundImage', "url('" + val + "')");
        }
        this.notFirstTime = true;
        // this.renderer.setStyle(this.result, 'backgroundImage', val);
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set _zoomImage(val) {
        this.previewImage = val;
        this.showResult = false;
        /** @type {?} */
        const image = new Image();
        image.src = this.zoomImage;
        image.onload = (/**
         * @return {?}
         */
        () => {
            this.showResult = true;
        });
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.img = this.imgElmRef.nativeElement;
        this.result = this.resultElmRef.nativeElement;
        this.container = this.containerElmRef.nativeElement;
        this.renderer.setAttribute(this.img, 'style', (/** @type {?} */ (this.imgStyle)));
        this.renderer.setAttribute(this.result, 'style', (/** @type {?} */ (this.resultStyle)));
        this.renderer.setAttribute(this.container, 'style', (/** @type {?} */ (this.containerStyle)));
        this.imageZoom();
        this.renderer.setStyle(this.lens, 'visibility', 'hidden');
        this.renderer.listen(this.img, 'mouseout', (/**
         * @return {?}
         */
        () => {
            this.hide = true;
            this.renderer.setStyle(this.lens, 'visibility', 'hidden');
        }));
    }
    /**
     * @return {?}
     */
    imageZoom() {
        /*create lens:*/
        this.lens = this.renderer.createElement('DIV');
        this.renderer.addClass(this.lens, 'img-zoom-lens');
        this.renderer.setAttribute(this.lens, 'style', (/** @type {?} */ (this.lensStyle)));
        /*insert lens:*/
        this.renderer.insertBefore(this.img.parentElement, this.lens, this.img);
        /*calculate the ratio between result DIV and lens:*/
        this.cx = this.result.offsetWidth / this.lens.offsetWidth;
        this.cy = this.result.offsetHeight / this.lens.offsetHeight;
        /*set background properties for the result DIV:*/
        this.renderer.setStyle(this.result, 'backgroundImage', "url('" + this.zoomImage + "')");
        this.renderer.setStyle(this.result, 'backgroundSize', (this.img.width * this.cx) + 'px ' + (this.img.height * this.cy) + 'px');
        // this.renderer.setStyle(this.img.parentElement, 'position', 'relative')
        /*execute a function when someone moves the cursor over the image, or the lens:*/
        this.renderer.listen(this.lens, 'mousemove', this.moveLens.bind(this));
        this.renderer.listen(this.img, 'mousemove', this.moveLens.bind(this));
        /*and also for touch screens:*/
        this.renderer.listen(this.img, 'touchmove', this.moveLens.bind(this));
        this.renderer.listen(this.lens, 'touchmove', this.moveLens.bind(this));
    }
    /**
     * @param {?} e
     * @return {?}
     */
    moveLens(e) {
        /** @type {?} */
        let pos;
        /** @type {?} */
        let x;
        /** @type {?} */
        let y;
        /*prevent any other actions that may occur when moving over the image:*/
        e.preventDefault();
        /*get the cursor's x and y positions:*/
        pos = this.getCursorPos(e);
        /*calculate the position of the lens:*/
        x = pos.x - (this.lens.offsetWidth / 2);
        y = pos.y - (this.lens.offsetHeight / 2);
        /*prevent the lens from being positioned outside the image:*/
        if (x > this.img.width - this.lens.offsetWidth) {
            x = this.img.width - this.lens.offsetWidth;
            this.hide = true;
            this.renderer.setStyle(this.lens, 'visibility', 'hidden');
        }
        else {
            this.hide = false;
            if (this.showResult) {
                this.renderer.setStyle(this.lens, 'visibility', 'visible');
            }
        }
        if (x < 0) {
            x = 0;
            this.hide = true;
            this.renderer.setStyle(this.lens, 'visibility', 'hidden');
        }
        if (y > this.img.height - this.lens.offsetHeight) {
            y = this.img.height - this.lens.offsetHeight;
            this.hide = true;
            this.renderer.setStyle(this.lens, 'visibility', 'hidden');
        }
        if (y < 0) {
            y = 0;
            this.hide = true;
            this.renderer.setStyle(this.lens, 'visibility', 'hidden');
        }
        /*set the position of the lens:*/
        this.renderer.setStyle(this.lens, 'left', x + 'px');
        this.renderer.setStyle(this.lens, 'top', y + 'px');
        /*display what the lens 'sees':*/
        this.renderer.setStyle(this.result, 'backgroundPosition', '-' + (x * this.cx) + 'px -' + (y * this.cy) + 'px');
    }
    /**
     * @param {?} e
     * @return {?}
     */
    getCursorPos(e) {
        /** @type {?} */
        let a;
        /** @type {?} */
        let x = 0;
        /** @type {?} */
        let y = 0;
        e = e || window.event;
        /*get the x and y positions of the image:*/
        a = this.img.getBoundingClientRect();
        /*calculate the cursor's x and y coordinates, relative to the image:*/
        x = e.pageX - a.left;
        y = e.pageY - a.top;
        /*consider any page scrolling:*/
        x = x - window.pageXOffset;
        y = y - window.pageYOffset;
        return { x: x, y: y };
    }
    /**
     * @return {?}
     */
    handleMouseLeave() {
        this.hide = true;
        this.renderer.setStyle(this.lens, 'visibility', 'hidden');
    }
}
NgxImgZoomComponent.decorators = [
    { type: Component, args: [{
                selector: 'ngx-img-zoom',
                template: "<div  class=\"img-zoom-container\" #container>\n    <img id=\"myimage\" [src]=\"previewImage\" #img (mouseleave)=\"handleMouseLeave()\">\n    <div [ngClass]=\"{'hide': hide || !showResult}\" \n        id=\"myresult\" \n        class=\"img-zoom-result\" \n        #result>\n    </div>\n</div>  ",
                styles: ["*{box-sizing:border-box}.img-zoom-container{position:absolute}.img-zoom-lens{position:absolute;border:1px solid #d4d4d4;width:40px;height:40px}.img-zoom-result{border:1px solid #d4d4d4;width:300px;height:300px}.hide{visibility:hidden}"]
            }] }
];
/** @nocollapse */
NgxImgZoomComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: NgxImgZoomService }
];
NgxImgZoomComponent.propDecorators = {
    imgElmRef: [{ type: ViewChild, args: ['img',] }],
    resultElmRef: [{ type: ViewChild, args: ['result',] }],
    containerElmRef: [{ type: ViewChild, args: ['container',] }],
    imgStyle: [{ type: Input }],
    resultStyle: [{ type: Input }],
    lensStyle: [{ type: Input }],
    containerStyle: [{ type: Input }],
    onscroll: [{ type: HostListener, args: ['window:scroll', ['$event'],] }],
    onclick: [{ type: HostListener, args: ['window:click', ['$event.target'],] }],
    _imgSrc: [{ type: Input, args: ['zoomImageSrc',] }],
    _zoomImage: [{ type: Input, args: ['previewImageSrc',] }]
};
if (false) {
    /** @type {?} */
    NgxImgZoomComponent.prototype.img;
    /** @type {?} */
    NgxImgZoomComponent.prototype.lens;
    /** @type {?} */
    NgxImgZoomComponent.prototype.result;
    /** @type {?} */
    NgxImgZoomComponent.prototype.cx;
    /** @type {?} */
    NgxImgZoomComponent.prototype.cy;
    /** @type {?} */
    NgxImgZoomComponent.prototype.container;
    /** @type {?} */
    NgxImgZoomComponent.prototype.hide;
    /** @type {?} */
    NgxImgZoomComponent.prototype._triggerAnimationIn;
    /** @type {?} */
    NgxImgZoomComponent.prototype.notFirstTime;
    /** @type {?} */
    NgxImgZoomComponent.prototype.showResult;
    /** @type {?} */
    NgxImgZoomComponent.prototype.zoomMode;
    /** @type {?} */
    NgxImgZoomComponent.prototype.imgElmRef;
    /** @type {?} */
    NgxImgZoomComponent.prototype.resultElmRef;
    /** @type {?} */
    NgxImgZoomComponent.prototype.containerElmRef;
    /** @type {?} */
    NgxImgZoomComponent.prototype._imgStyle;
    /** @type {?} */
    NgxImgZoomComponent.prototype._resultStyle;
    /** @type {?} */
    NgxImgZoomComponent.prototype._lensStyle;
    /** @type {?} */
    NgxImgZoomComponent.prototype.containerStyle;
    /** @type {?} */
    NgxImgZoomComponent.prototype.zoomImage;
    /** @type {?} */
    NgxImgZoomComponent.prototype.previewImage;
    /**
     * @type {?}
     * @private
     */
    NgxImgZoomComponent.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    NgxImgZoomComponent.prototype.ngxZoomService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWltZy16b29tLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1pbWctem9vbS8iLCJzb3VyY2VzIjpbImxpYi9uZ3gtaW1nLXpvb20uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFNBQVMsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFpQixLQUFLLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hILE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBTzNELE1BQU0sT0FBTyxtQkFBbUI7Ozs7O0lBTzlCLFlBQ1UsUUFBbUIsRUFDbkIsY0FBaUM7UUFEakMsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNuQixtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUFOM0MsU0FBSSxHQUFHLElBQUksQ0FBQztRQUNaLHdCQUFtQixHQUFHLEtBQUssQ0FBQztRQUM1QixpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUNyQixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBTWpCLGFBQVEsR0FBbUIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUM7SUFGcEQsQ0FBQzs7Ozs7SUFTTCxJQUFhLFFBQVEsQ0FBQyxHQUFHO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDO0lBQ3ZCLENBQUM7Ozs7SUFDRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDeEIsQ0FBQzs7Ozs7SUFHRCxJQUFhLFdBQVcsQ0FBQyxHQUFHO1FBQzFCLElBQUksQ0FBQyxZQUFZLEdBQUcsR0FBRyxDQUFDO0lBQzFCLENBQUM7Ozs7SUFDRCxJQUFJLFdBQVc7UUFDYixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQzs7Ozs7SUFHRCxJQUFhLFNBQVMsQ0FBQyxHQUFHO1FBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FB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QUFXOztJQVVYLDZDQUF3Qjs7SUFDeEIsd0NBQVU7O0lBQ1YsMkNBQWE7Ozs7O0lBdENiLHVDQUEyQjs7Ozs7SUFDM0IsNkNBQXlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFJlbmRlcmVyMiwgRWxlbWVudFJlZiwgVmlld0NoaWxkLCBBZnRlclZpZXdJbml0LCBJbnB1dCwgSG9zdExpc3RlbmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ3hJbWdab29tU2VydmljZSB9IGZyb20gJy4vbmd4LWltZy16b29tLnNlcnZpY2UnO1xuaW1wb3J0IHsgTmd4SW1nWm9vbU1vZGUgfSBmcm9tICcuL21vZGUuZW51bSc7XG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICduZ3gtaW1nLXpvb20nLFxuICB0ZW1wbGF0ZVVybDogJy4vbmd4LWltZy16b29tLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbmd4LWltZy16b29tLmNvbXBvbmVudC5jc3MnXSxcbn0pXG5leHBvcnQgY2xhc3MgTmd4SW1nWm9vbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCB7XG5cbiAgaW1nOyBsZW5zOyByZXN1bHQ7IGN4OyBjeTsgY29udGFpbmVyO1xuICBoaWRlID0gdHJ1ZTtcbiAgX3RyaWdnZXJBbmltYXRpb25JbiA9IGZhbHNlO1xuICBub3RGaXJzdFRpbWUgPSBmYWxzZTtcbiAgc2hvd1Jlc3VsdCA9IGZhbHNlO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSBuZ3hab29tU2VydmljZTogTmd4SW1nWm9vbVNlcnZpY2VcbiAgICApIHsgfVxuXG4gICAgem9vbU1vZGU6IE5neEltZ1pvb21Nb2RlID0gdGhpcy5uZ3hab29tU2VydmljZS56b29tTW9kZTtcbiAgICBAVmlld0NoaWxkKCdpbWcnKSBpbWdFbG1SZWY6IEVsZW1lbnRSZWY7XG4gICAgQFZpZXdDaGlsZCgncmVzdWx0JykgcmVzdWx0RWxtUmVmOiBFbGVtZW50UmVmO1xuICAgIEBWaWV3Q2hpbGQoJ2NvbnRhaW5lcicpIGNvbnRhaW5lckVsbVJlZjogRWxlbWVudFJlZjtcblxuXG4gICAgX2ltZ1N0eWxlO1xuICAgIEBJbnB1dCgpIHNldCBpbWdTdHlsZSh2YWwpIHtcbiAgICAgIHRoaXMuX2ltZ1N0eWxlID0gdmFsO1xuICAgIH1cbiAgICBnZXQgaW1nU3R5bGUoKSB7XG4gICAgICByZXR1cm4gdGhpcy5faW1nU3R5bGU7XG4gICAgfVxuXG4gICAgX3Jlc3VsdFN0eWxlO1xuICAgIEBJbnB1dCgpIHNldCByZXN1bHRTdHlsZSh2YWwpIHtcbiAgICAgIHRoaXMuX3Jlc3VsdFN0eWxlID0gdmFsO1xuICAgIH1cbiAgICBnZXQgcmVzdWx0U3R5bGUoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fcmVzdWx0U3R5bGU7XG4gICAgfVxuXG4gICAgX2xlbnNTdHlsZTtcbiAgICBASW5wdXQoKSBzZXQgbGVuc1N0eWxlKHZhbCkge1xuICAgICAgdGhpcy5fbGVuc1N0eWxlID0gdmFsO1xuICAgICAgaWYgKHRoaXMubm90Rmlyc3RUaW1lKSB7XG4gICAgICAgIHRoaXMuaW1hZ2Vab29tKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGdldCBsZW5zU3R5bGUoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fbGVuc1N0eWxlO1xuICAgIH1cbiAgICBASW5wdXQoKSBjb250YWluZXJTdHlsZTtcbiAgICB6b29tSW1hZ2U7XG4gICAgcHJldmlld0ltYWdlO1xuXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpzY3JvbGwnLCBbJyRldmVudCddKSBvbnNjcm9sbChldmVudCkge1xuICAgIHRoaXMuaGlkZSA9IHRydWU7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxlbnMsICd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xuICB9XG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpjbGljaycsIFsnJGV2ZW50LnRhcmdldCddKSBvbmNsaWNrKGV2ZW50KSB7XG4gICAgdGhpcy5oaWRlID0gdHJ1ZTtcbiAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMubGVucywgJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XG4gIH1cblxuICBASW5wdXQoJ3pvb21JbWFnZVNyYycpIHNldCBfaW1nU3JjKHZhbCkge1xuICAgIHRoaXMuem9vbUltYWdlID0gdmFsO1xuICAgIGlmICh0aGlzLm5vdEZpcnN0VGltZSA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLnJlc3VsdCwgJ2JhY2tncm91bmRJbWFnZScsIFwidXJsKCdcIiArIHZhbCArIFwiJylcIik7XG4gICAgfVxuICAgIHRoaXMubm90Rmlyc3RUaW1lID0gdHJ1ZTtcbiAgICAvLyB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMucmVzdWx0LCAnYmFja2dyb3VuZEltYWdlJywgdmFsKTtcbiAgfVxuXG4gIEBJbnB1dCgncHJldmlld0ltYWdlU3JjJykgc2V0IF96b29tSW1hZ2UodmFsKSB7XG4gICAgdGhpcy5wcmV2aWV3SW1hZ2UgPSB2YWw7XG4gICAgdGhpcy5zaG93UmVzdWx0ID0gZmFsc2U7XG4gICAgY29uc3QgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcbiAgICBpbWFnZS5zcmMgPSB0aGlzLnpvb21JbWFnZTtcbiAgICBpbWFnZS5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICB0aGlzLnNob3dSZXN1bHQgPSB0cnVlO1xuICAgIH07XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmltZyA9IHRoaXMuaW1nRWxtUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgdGhpcy5yZXN1bHQgPSB0aGlzLnJlc3VsdEVsbVJlZi5uYXRpdmVFbGVtZW50O1xuICAgIHRoaXMuY29udGFpbmVyID0gdGhpcy5jb250YWluZXJFbG1SZWYubmF0aXZlRWxlbWVudDtcblxuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuaW1nLCAnc3R5bGUnLCA8c3RyaW5nPnRoaXMuaW1nU3R5bGUpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMucmVzdWx0LCAnc3R5bGUnLCA8c3RyaW5nPnRoaXMucmVzdWx0U3R5bGUpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMuY29udGFpbmVyLCAnc3R5bGUnLCA8c3RyaW5nPnRoaXMuY29udGFpbmVyU3R5bGUpO1xuICAgIHRoaXMuaW1hZ2Vab29tKCk7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxlbnMsICd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xuICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuaW1nLCAnbW91c2VvdXQnLCAoKSA9PiB7XG4gICAgICB0aGlzLmhpZGUgPSB0cnVlO1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxlbnMsICd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xuICAgICB9KTtcbiAgfVxuXG5cbiAgaW1hZ2Vab29tKCkge1xuICAgIC8qY3JlYXRlIGxlbnM6Ki9cbiAgICB0aGlzLmxlbnMgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ0RJVicpO1xuICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5sZW5zLCAnaW1nLXpvb20tbGVucycpO1xuICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRoaXMubGVucywgJ3N0eWxlJywgPHN0cmluZz50aGlzLmxlbnNTdHlsZSk7XG5cbiAgICAvKmluc2VydCBsZW5zOiovXG4gICAgdGhpcy5yZW5kZXJlci5pbnNlcnRCZWZvcmUodGhpcy5pbWcucGFyZW50RWxlbWVudCwgdGhpcy5sZW5zLCB0aGlzLmltZyk7XG5cbiAgICAvKmNhbGN1bGF0ZSB0aGUgcmF0aW8gYmV0d2VlbiByZXN1bHQgRElWIGFuZCBsZW5zOiovXG4gICAgdGhpcy5jeCA9IHRoaXMucmVzdWx0Lm9mZnNldFdpZHRoIC8gdGhpcy5sZW5zLm9mZnNldFdpZHRoO1xuICAgIHRoaXMuY3kgPSB0aGlzLnJlc3VsdC5vZmZzZXRIZWlnaHQgLyB0aGlzLmxlbnMub2Zmc2V0SGVpZ2h0O1xuXG4gICAgLypzZXQgYmFja2dyb3VuZCBwcm9wZXJ0aWVzIGZvciB0aGUgcmVzdWx0IERJVjoqL1xuICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5yZXN1bHQsICdiYWNrZ3JvdW5kSW1hZ2UnLCBcInVybCgnXCIgKyB0aGlzLnpvb21JbWFnZSArIFwiJylcIik7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLnJlc3VsdCwgJ2JhY2tncm91bmRTaXplJywgKHRoaXMuaW1nLndpZHRoICogdGhpcy5jeCkgKyAncHggJyArICh0aGlzLmltZy5oZWlnaHQgKiB0aGlzLmN5KSArICdweCcpO1xuICAgIC8vIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5pbWcucGFyZW50RWxlbWVudCwgJ3Bvc2l0aW9uJywgJ3JlbGF0aXZlJylcblxuICAgIC8qZXhlY3V0ZSBhIGZ1bmN0aW9uIHdoZW4gc29tZW9uZSBtb3ZlcyB0aGUgY3Vyc29yIG92ZXIgdGhlIGltYWdlLCBvciB0aGUgbGVuczoqL1xuICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMubGVucywgJ21vdXNlbW92ZScsIHRoaXMubW92ZUxlbnMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy5pbWcsICdtb3VzZW1vdmUnLCB0aGlzLm1vdmVMZW5zLmJpbmQodGhpcykpO1xuXG4gICAgLyphbmQgYWxzbyBmb3IgdG91Y2ggc2NyZWVuczoqL1xuICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuaW1nLCAndG91Y2htb3ZlJywgdGhpcy5tb3ZlTGVucy5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmxlbnMsICd0b3VjaG1vdmUnLCB0aGlzLm1vdmVMZW5zLmJpbmQodGhpcykpO1xuICB9XG5cbiAgbW92ZUxlbnMoZSkge1xuICAgICAgbGV0IHBvcywgeCwgeTtcbiAgICAgIC8qcHJldmVudCBhbnkgb3RoZXIgYWN0aW9ucyB0aGF0IG1heSBvY2N1ciB3aGVuIG1vdmluZyBvdmVyIHRoZSBpbWFnZToqL1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgLypnZXQgdGhlIGN1cnNvcidzIHggYW5kIHkgcG9zaXRpb25zOiovXG4gICAgICBwb3MgPSB0aGlzLmdldEN1cnNvclBvcyhlKTtcbiAgICAgIC8qY2FsY3VsYXRlIHRoZSBwb3NpdGlvbiBvZiB0aGUgbGVuczoqL1xuICAgICAgeCA9IHBvcy54IC0gKHRoaXMubGVucy5vZmZzZXRXaWR0aCAvIDIpO1xuICAgICAgeSA9IHBvcy55IC0gKHRoaXMubGVucy5vZmZzZXRIZWlnaHQgLyAyKTtcblxuXG4gICAgICAvKnByZXZlbnQgdGhlIGxlbnMgZnJvbSBiZWluZyBwb3NpdGlvbmVkIG91dHNpZGUgdGhlIGltYWdlOiovXG4gICAgICBpZiAoeCA+IHRoaXMuaW1nLndpZHRoIC0gdGhpcy5sZW5zLm9mZnNldFdpZHRoKSB7XG4gICAgICAgIHggPSB0aGlzLmltZy53aWR0aCAtIHRoaXMubGVucy5vZmZzZXRXaWR0aDtcblxuICAgICAgICB0aGlzLmhpZGUgPSB0cnVlO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMubGVucywgJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmhpZGUgPSBmYWxzZTtcbiAgICAgICAgaWYgKHRoaXMuc2hvd1Jlc3VsdCkge1xuICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5sZW5zLCAndmlzaWJpbGl0eScsICd2aXNpYmxlJyk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHggPCAwKSB7XG4gICAgICAgIHggPSAwO1xuICAgICAgICB0aGlzLmhpZGUgPSB0cnVlO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMubGVucywgJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICh5ID4gdGhpcy5pbWcuaGVpZ2h0IC0gdGhpcy5sZW5zLm9mZnNldEhlaWdodCkge1xuICAgICAgICB5ID0gdGhpcy5pbWcuaGVpZ2h0IC0gdGhpcy5sZW5zLm9mZnNldEhlaWdodDtcbiAgICAgICAgdGhpcy5oaWRlID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxlbnMsICd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xuICAgICAgfVxuXG4gICAgICBpZiAoeSA8IDApIHtcbiAgICAgICAgeSA9IDA7XG4gICAgICAgIHRoaXMuaGlkZSA9IHRydWU7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5sZW5zLCAndmlzaWJpbGl0eScsICdoaWRkZW4nKTtcbiAgICAgIH1cblxuICAgICAgLypzZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBsZW5zOiovXG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMubGVucywgJ2xlZnQnLCB4ICsgJ3B4Jyk7XG4gICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMubGVucywgJ3RvcCcsIHkgKyAncHgnKTtcbiAgICAgIC8qZGlzcGxheSB3aGF0IHRoZSBsZW5zICdzZWVzJzoqL1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLnJlc3VsdCwgJ2JhY2tncm91bmRQb3NpdGlvbicsICctJyArICh4ICogdGhpcy5jeCkgKyAncHggLScgKyAoeSAqIHRoaXMuY3kpICsgJ3B4Jyk7XG4gICAgfVxuXG4gIGdldEN1cnNvclBvcyhlKSB7XG4gICAgICBsZXQgYSwgeCA9IDAsIHkgPSAwO1xuICAgICAgZSA9IGUgfHwgd2luZG93LmV2ZW50O1xuICAgICAgLypnZXQgdGhlIHggYW5kIHkgcG9zaXRpb25zIG9mIHRoZSBpbWFnZToqL1xuICAgICAgYSA9IHRoaXMuaW1nLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgLypjYWxjdWxhdGUgdGhlIGN1cnNvcidzIHggYW5kIHkgY29vcmRpbmF0ZXMsIHJlbGF0aXZlIHRvIHRoZSBpbWFnZToqL1xuICAgICAgeCA9IGUucGFnZVggLSBhLmxlZnQ7XG4gICAgICB5ID0gZS5wYWdlWSAtIGEudG9wO1xuICAgICAgLypjb25zaWRlciBhbnkgcGFnZSBzY3JvbGxpbmc6Ki9cbiAgICAgIHggPSB4IC0gd2luZG93LnBhZ2VYT2Zmc2V0O1xuICAgICAgeSA9IHkgLSB3aW5kb3cucGFnZVlPZmZzZXQ7XG4gICAgICByZXR1cm4ge3ggOiB4LCB5IDogeX07XG4gIH1cblxuICBoYW5kbGVNb3VzZUxlYXZlKCkge1xuICAgIHRoaXMuaGlkZSA9IHRydWU7XG4gICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmxlbnMsICd2aXNpYmlsaXR5JywgJ2hpZGRlbicpO1xuICB9XG5cbn1cbiJdfQ==